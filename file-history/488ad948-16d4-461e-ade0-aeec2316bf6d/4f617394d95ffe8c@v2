from __future__ import annotations

import json
import re

import pandas as pd

def clean_text(text: str) -> str:
    """Remove template variables and clean text."""
    if not text:
        return ''

    # Remove template variables like {{ Admin }}, {{ Support }}, etc.
    text = re.sub(r'\{\{[^}]+\}\}', '', text)

    # Remove "Register" text
    text = re.sub(r'Register\s*\d*\s*(Courses?|min|hr)?', '', text, flags=re.IGNORECASE)

    # Remove role/color/category attributes
    text = re.sub(r'role-[\w-]+', '', text)
    text = re.sub(r'color-#[0-9a-fA-F]+', '', text)
    text = re.sub(r'#[0-9a-fA-F]{6}', '', text)
    text = re.sub(r'category-[\w-]+', '', text)

    # Remove stray time indicators that are part of metadata
    text = re.sub(r'\b\d+\+?\s*hours?\b', '', text)
    text = re.sub(r'\b\d+\s*min\s*-\s*\d+\s*hours?\b', '', text)

    # Clean up extra whitespace
    text = re.sub(r'\s+', ' ', text)
    text = text.strip()

    return text

def extract_metadata_from_title(title: str) -> dict:
    """Extract duration, level, and other metadata from title."""
    metadata = {
        'duration': '',
        'level': '',
        'language': []
    }

    # Extract duration patterns
    duration_match = re.search(r'(\d+\s*(?:hr|min|hours?|minutes?)(?:\s*-?\s*\d+\s*(?:hr|min|hours?|minutes?))?)', title, re.IGNORECASE)
    if duration_match:
        metadata['duration'] = duration_match.group(1)

    # Extract level
    level_match = re.search(r'\b(Beginner|Intermediate|Advanced|Expert|Specialist)\b', title, re.IGNORECASE)
    if level_match:
        metadata['level'] = level_match.group(1)

    # Extract languages
    languages = []
    if 'Japanese' in title or re.search(r'[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf]', title):
        languages.append('Japanese')
    if 'German' in title or 'Lernpfad' in title or 'für' in title:
        languages.append('German')
    if 'Spanish' in title or 'Ruta de aprendizaje' in title or 'para' in title:
        languages.append('Spanish')
    if 'French' in title or 'Parcours' in title or 'pour les' in title:
        languages.append('French')
    if 'Portuguese' in title or 'Caminho de aprendizado' in title or 'para' in title:
        languages.append('Portuguese')

    if languages:
        metadata['language'] = ', '.join(set(languages))
    else:
        metadata['language'] = 'English'

    return metadata

# Load the JSON data
with open('zendesk_catalog.json', 'r', encoding='utf-8') as f:
    courses = json.load(f)

print(f"Processing {len(courses)} courses...")

# Clean each course
for course in courses:
    # Clean title
    original_title = course['title']
    metadata = extract_metadata_from_title(original_title)

    # Apply metadata
    if not course.get('duration'):
        course['duration'] = metadata['duration']
    if not course.get('level'):
        course['level'] = metadata['level']
    course['language'] = metadata['language']

    # Clean the title
    course['title'] = clean_text(original_title)

    # Clean description
    course['description'] = clean_text(course.get('description', ''))

    # Extract role from original title
    if 'Agent' in original_title and 'role-agent' in original_title:
        course['target_role'] = 'Agent'
    elif 'Admin' in original_title or 'role-admin' in original_title:
        course['target_role'] = 'Admin'
    elif 'Analyst' in original_title or 'role-cx-analyst' in original_title:
        course['target_role'] = 'Analyst'
    elif 'Developer' in original_title:
        course['target_role'] = 'Developer'
    else:
        course['target_role'] = ''

print(f"\nCleaned {len(courses)} courses")

# Save cleaned data
with open('zendesk_catalog.json', 'w', encoding='utf-8') as f:
    json.dump(courses, f, indent=2, ensure_ascii=False)

# Update CSV
df = pd.DataFrame(courses)
column_order = [
    'provider', 'title', 'url', 'description', 'duration',
    'level', 'format', 'price', 'category', 'learning_path',
    'language', 'target_role', 'date_scraped'
]
existing_cols = [col for col in column_order if col in df.columns]
df = df[existing_cols]
df.to_csv('zendesk_catalog.csv', index=False, encoding='utf-8')

print("✓ Updated zendesk_catalog.json")
print("✓ Updated zendesk_catalog.csv")

# Show sample of cleaned data
print("\nSample cleaned courses:")
for i, course in enumerate(courses[:3], 1):
    print(f"\n{i}. {course['title']}")
    print(f"   Language: {course.get('language', 'English')}")
    print(f"   Duration: {course.get('duration', 'N/A')}")
    print(f"   Target Role: {course.get('target_role', 'N/A')}")
